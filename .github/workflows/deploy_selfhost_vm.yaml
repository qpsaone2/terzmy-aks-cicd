name: Build and Deploy to AKS (Self-Hosted Runner)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'dev'
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'app/**'

env:
  ACR_LOGIN_SERVER: acrhyosungdev.azurecr.io
  ACR_NAME: acrhyosungdev 
  IMAGE_NAME: myapp
  AKS_CLUSTER: aks-hyosung-dev
  AKS_RESOURCE_GROUP: rg-hyosung-dev
  NAMESPACE: dev

jobs:
  build:
    name: Build and Push Image
    runs-on: self-hosted
    outputs:
      version_tag: ${{ steps.version.outputs.VERSION_TAG }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Login to Azure with Managed Identity
      run: |
        az login --identity
        echo "‚úÖ Logged in to Azure using VM Managed Identity"
    
    - name: Generate Version Tag
      id: version
      run: |
        LATEST_VERSION=$(az acr repository show-tags \
          --name $ACR_NAME \
          --repository $IMAGE_NAME \
          --orderby time_desc \
          --output tsv 2>/dev/null | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
        
        if [ -z "$LATEST_VERSION" ]; then
          NEW_VERSION="v1.0.1"
        else
          MAJOR=$(echo $LATEST_VERSION | cut -d. -f1 | sed 's/v//')
          MINOR=$(echo $LATEST_VERSION | cut -d. -f2)
          PATCH=$(echo $LATEST_VERSION | cut -d. -f3)
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
        fi

        echo "VERSION_TAG=${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "‚úÖ New version: ${NEW_VERSION}"
    
    - name: Login to ACR
      run: |
        az acr login --name $ACR_NAME
    
    - name: Build Docker Image
      run: |
        cd app
        docker build \
          -t $ACR_LOGIN_SERVER/$IMAGE_NAME:latest \
          -t $ACR_LOGIN_SERVER/$IMAGE_NAME:${{ steps.version.outputs.VERSION_TAG }} \
          .
        
        echo "‚úÖ Built image with tags:"
        echo "  - latest"
        echo "  - ${{ steps.version.outputs.VERSION_TAG }}"
    
    - name: Push Image to ACR
      run: |
        docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
        docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:${{ steps.version.outputs.VERSION_TAG }}
        
        echo "‚úÖ Pushed images:"
        echo "  - latest"
        echo "  - ${{ steps.version.outputs.VERSION_TAG }}"
    
    - name: Build Summary
      run: |
        echo "=========================================="
        echo "‚úÖ Build Completed!"
        echo "=========================================="
        echo ""
        echo "üì¶ Version: ${{ steps.version.outputs.VERSION_TAG }}"
        echo "üè∑Ô∏è  Tags: latest, ${{ steps.version.outputs.VERSION_TAG }}"
        echo ""

  deploy:
    name: Deploy to AKS
    runs-on: self-hosted
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Login to Azure with Managed Identity
      run: |
        az login --identity

    - name: Set AKS Context
      run: |
        az aks get-credentials \
          --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
          --name ${{ env.AKS_CLUSTER }} \
          --overwrite-existing
    
    - name: Test Kubernetes Connection
      run: |
        kubectl get nodes
        kubectl get namespaces
    
    - name: Create Namespace
      run: |
        kubectl apply -f k8s/namespace.yaml
    
    - name: Deploy StorageClass
      run: |
        if ! kubectl get storageclass azureblob-fuse-premium > /dev/null 2>&1; then
          echo "Creating StorageClass..."
          kubectl apply -f k8s/storageclass.yaml
        else
          echo "‚úÖ StorageClass already exists"
        fi
    
    - name: Deploy PVC (Dynamic Provisioning)
      run: |
        kubectl apply -f k8s/pvc.yaml
        
        echo "‚è≥ Waiting for PVC to be Bound (auto-creating PV and Blob Container)..."
        kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/blob-pvc -n dev --timeout=120s || \
          (kubectl describe pvc blob-pvc -n dev && exit 1)
        
        echo "‚úÖ PVC Bound - Blob Container automatically created!"
        
        PV_NAME=$(kubectl get pvc blob-pvc -n dev -o jsonpath='{.spec.volumeName}')
        echo "üì¶ Auto-created PV: $PV_NAME"
    
    - name: Deploy Application
      run: |
        VERSION_TAG="${{ needs.build.outputs.version_tag }}"
        
        sed -i "s|image: .*/myapp:.*|image: $ACR_LOGIN_SERVER/$IMAGE_NAME:$VERSION_TAG|g" k8s/deployment.yaml
        
        kubectl apply -f k8s/deployment.yaml
        
        echo "‚úÖ Deployed version: $VERSION_TAG"
    
    - name: Deploy Service
      run: |
        kubectl apply -f k8s/service.yaml
    
    - name: Check Rollout Status
      run: |
        kubectl rollout status deployment/app-deployment -n $NAMESPACE --timeout=5m
    
    - name: Display Deployment Info
      run: |
        echo "=========================================="
        echo "‚úÖ Deployment Successful!"
        echo "=========================================="
        echo ""
        echo "üì¶ Deployed Version: ${{ needs.build.outputs.version_tag }}"
        echo ""
        
        echo "=== Pods ==="
        kubectl get pods -n $NAMESPACE -l app=myapp -o wide
        
        echo ""
        echo "=== Service ==="
        kubectl get svc app-service -n $NAMESPACE
        
        echo ""
        EXTERNAL_IP=$(kubectl get svc app-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
        if [ -z "$EXTERNAL_IP" ]; then
          echo "‚è≥ External IP pending..."
        else
          echo "üåê Access URL: http://$EXTERNAL_IP"
        fi
        
        echo ""
        echo "=== All Versions in ACR ==="
        az acr repository show-tags \
          --name $ACR_NAME \
          --repository $IMAGE_NAME \
          --orderby time_desc \
          --output table
        
        echo ""
        echo "=== Pod Node Assignment ==="
        kubectl get pods -n $NAMESPACE -l app=myapp -o custom-columns=NAME:.metadata.name,NODE:.spec.nodeName,STATUS:.status.phase